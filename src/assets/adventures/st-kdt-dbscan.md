# Spatiotemoral kd-tree DBSCAN

Clustering geospatial event data requires defining a distance function between events as well as representing neighborhood characteristics where an event occurred in numerical or categorical values. One of the biggest problems with clustering algorithms is how to improve the clustering process to scale well for very large datasets. The Spatio-Temporal k-Dimensional Tree-based DBSCAN (ST-KDT-DBSCAN) clustering approach that restricts the search radius for each event during clustering by first organizing the dataset into a k-dimensional tree structure, subsequently creating a Fixed-Radius Near Neighbor (FRNN) object for each event, and then carrying out DBSCAN considering only each eventâ€™s FRNN object when computing reachability.

## Implementation
This implementation of k-d tree has three dimensions (i.e., k = 3): (1) longitude, (2) latitude, and (3) date with the date stored in the YYYYMMDD format to allow for numeric sorting. The dataset is first sorted based on the longitudes only, we then find the median longitude value in this sorted dataset and create a root node with it. Each data point with a longitude value higher than this median is passed to the left branch and that with a lower value is stored in the right branch. Then we carry out the process for the latitude and date dimensions for the second and third levels, respectively. The fourth level is again sorted based on longitude (first dimension), the fifth by latitude (second dimension) and the sixth by date (third dimension). The n^th level is sorted by the [((n-1)mod k)+1]th dimension. This process is repeated until the whole dataset is organized.

Since we only store data point pairs that are within a spatial and temporal distance of one another, we use a Fixed-Radius Near Neighbors (FRNN) algorithm. Given a set of data points and a radius (r > 0), the FRNN algorithm returns all pairs of points within a distance of r from each other. In our implementation, for each data point, we store the ID of all other data points that are within a given spatial and temporal radius from it. The radius is an ordered list (tuple) with two values: the first value is the spatial radius in kilometers (km) and the second value is the temporal radius (days). The algorithm then traverses through the k-d tree and finds all the data points inside this radius for each point. Figure 2 illustrates an example of a 3-d tree for a data point (i.e., an event) in our framework. Note that the tree branches are created based on the numeric values of all the variables (dimensions), not on any spatial or temporal distance calculation. Thus, implementation-wise, in order to computationally identify neighboring events of an event specifically, we create a bounding box for each point to restrict the search area to find these neighboring events.

While the temporal bounding is simple to construct, the geospatial bounding requires geospatial distance calculation. For each data point, we first take the geospatial coordinates and create four new points at a spatial distance given by the radius and bearing angles of 0, 90, 180 and 270 degrees. (Bearing is the angle between a line connecting two points and a north-south line.) The distances are calculated using a variation of the haversine formula.
$$lat2=\arcsin\left(\sin{lat1}.\cos{\frac{d}{R}}+\cos{lat1}.\sin{\frac{d}{R}}\cos{B}\right)$$

$$lon2=lon1+\arctan2{\left(\sin{B}.\sin{\frac{d}{R}}.\cos{lat1},\cos{\frac{d}{R}}-\sin{lat1}.\sin{lat2}\right)}$$

where lon1 and lat1 are the longitude and latitude of the data point, respectively, B the bearing angle, d the spatial radius (in kilometers or miles) value within which the search is to be restricted and R the approximate radius of the Earth (same unit as the spatial radius). lon2 and lat2 are the longitude and latitude of the new point, respectively. Note that the longitude and latitude values must be in radians during calculation (rad = 180 degrees) and the final results are then converted back to degrees. Using this identification and conversion technique, we first calculate points in four cardinal directions from each point, and then get the maximum and minimum values of longitude and latitude from these four points to form a spatial bounding box. Figure 3 shows the process for the creation of spatial bounding box. Once we have the maximum and minimum values for longitude, latitude, and date, we simply traverse down the k-d tree to find all neighbors within the spatial and temporal bounds of the bounding box.
